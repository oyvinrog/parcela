#!/usr/bin/env bash
#
# bump_version - Update version across all project files
#
# Usage:
#   ./bump_version patch    # 0.1.0 -> 0.1.1
#   ./bump_version minor    # 0.1.0 -> 0.2.0
#   ./bump_version major    # 0.1.0 -> 1.0.0
#   ./bump_version 1.2.3    # Set exact version
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Files containing version strings
ROOT_CARGO="Cargo.toml"
TAURI_CARGO="src-tauri/Cargo.toml"
TAURI_CONF="src-tauri/tauri.conf.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: $0 <patch|minor|major|VERSION>"
    echo ""
    echo "Examples:"
    echo "  $0 patch     Bump patch version (0.1.0 -> 0.1.1)"
    echo "  $0 minor     Bump minor version (0.1.0 -> 0.2.0)"
    echo "  $0 major     Bump major version (0.1.0 -> 1.0.0)"
    echo "  $0 1.2.3     Set exact version"
    exit 1
}

get_current_version() {
    grep -m1 '^version' "$ROOT_CARGO" | sed 's/.*"\([^"]*\)".*/\1/'
}

bump_version() {
    local current="$1"
    local bump_type="$2"
    
    IFS='.' read -r major minor patch <<< "$current"
    
    case "$bump_type" in
        major)
            echo "$((major + 1)).0.0"
            ;;
        minor)
            echo "${major}.$((minor + 1)).0"
            ;;
        patch)
            echo "${major}.${minor}.$((patch + 1))"
            ;;
        *)
            echo "$bump_type"
            ;;
    esac
}

validate_version() {
    local version="$1"
    if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}Error: Invalid version format '$version'. Expected X.Y.Z${NC}"
        exit 1
    fi
}

update_cargo_toml() {
    local file="$1"
    local old_version="$2"
    local new_version="$3"
    
    if [[ ! -f "$file" ]]; then
        echo -e "${YELLOW}Warning: $file not found, skipping${NC}"
        return
    fi
    
    sed -i "s/^version = \"$old_version\"/version = \"$new_version\"/" "$file"
    echo -e "  ${GREEN}✓${NC} $file"
}

update_tauri_conf() {
    local file="$1"
    local old_version="$2"
    local new_version="$3"
    
    if [[ ! -f "$file" ]]; then
        echo -e "${YELLOW}Warning: $file not found, skipping${NC}"
        return
    fi
    
    sed -i "s/\"version\": \"$old_version\"/\"version\": \"$new_version\"/" "$file"
    echo -e "  ${GREEN}✓${NC} $file"
}

main() {
    if [[ $# -ne 1 ]]; then
        usage
    fi
    
    local bump_type="$1"
    local current_version
    current_version=$(get_current_version)
    
    if [[ -z "$current_version" ]]; then
        echo -e "${RED}Error: Could not determine current version from $ROOT_CARGO${NC}"
        exit 1
    fi
    
    local new_version
    case "$bump_type" in
        major|minor|patch)
            new_version=$(bump_version "$current_version" "$bump_type")
            ;;
        *)
            validate_version "$bump_type"
            new_version="$bump_type"
            ;;
    esac
    
    if [[ "$current_version" == "$new_version" ]]; then
        echo -e "${YELLOW}Version is already $current_version${NC}"
        exit 0
    fi
    
    echo -e "${BLUE}Bumping version: ${YELLOW}$current_version${NC} → ${GREEN}$new_version${NC}"
    echo ""
    echo "Updating files:"
    
    update_cargo_toml "$ROOT_CARGO" "$current_version" "$new_version"
    update_cargo_toml "$TAURI_CARGO" "$current_version" "$new_version"
    update_tauri_conf "$TAURI_CONF" "$current_version" "$new_version"
    
    echo ""
    echo -e "${GREEN}Done!${NC} Version updated to ${GREEN}$new_version${NC}"
    echo ""
    echo -e "${BLUE}Next steps:${NC}"
    echo "  git add -A"
    echo "  git commit -m \"chore: bump version to $new_version\""
    echo "  git tag -a v$new_version -m \"Release v$new_version\""
}

main "$@"

