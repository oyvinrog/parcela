name: Cross-Platform Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # UI Tests (JavaScript) - runs on all platforms
  test-ui:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package.json
      
      - name: Install UI dependencies
        working-directory: ui
        run: npm ci
      
      - name: Run UI tests
        working-directory: ui
        run: npm test -- --coverage
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: ui-coverage
          path: ui/coverage/
          if-no-files-found: ignore

  # Windows tests with WinFsp
  test-windows:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install WinFsp via Chocolatey
        run: |
          choco install -y winfsp
          
          # Find WinFsp installation path
          $winfspPath = $null
          if (Test-Path "C:\Program Files\WinFsp\bin\winfsp-x64.dll") {
            $winfspPath = "C:\Program Files\WinFsp"
            Write-Host "✓ WinFsp installed at: $winfspPath"
          } elseif (Test-Path "C:\Program Files (x86)\WinFsp\bin\winfsp-x64.dll") {
            $winfspPath = "C:\Program Files (x86)\WinFsp"
            Write-Host "✓ WinFsp installed at: $winfspPath (x86)"
          } else {
            Write-Error "✗ WinFsp installation failed - DLL not found"
            exit 1
          }
          
          # Add WinFsp bin directory to PATH (required for DLL loading at runtime)
          $binPath = "$winfspPath\bin"
          Write-Host "Adding to PATH: $binPath"
          echo "$binPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          # Set environment variables for WinFsp headers (needed for compilation)
          $incPath = "$winfspPath\inc\fuse"
          Write-Host "Setting CPATH: $incPath"
          echo "CPATH=$incPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # Also set WINFSP_INSTALL_DIR for the winfsp crate
          echo "WINFSP_INSTALL_DIR=$winfspPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh
      
      - name: Verify WinFsp in PATH
        run: |
          Write-Host "=== Environment Verification ==="
          
          # Show PATH entries containing WinFsp
          Write-Host "`nPATH entries with WinFsp:"
          $env:PATH -split ';' | Where-Object { $_ -match 'WinFsp' } | ForEach-Object { Write-Host "  $_" }
          
          # Get install dir from environment (set in previous step)
          $winfspDir = $env:WINFSP_INSTALL_DIR
          Write-Host "`nWINFSP_INSTALL_DIR: $winfspDir"
          
          if (-not $winfspDir) {
            Write-Error "WINFSP_INSTALL_DIR not set"
            exit 1
          }
          
          # Check for DLL - try both x64 and x86
          $dllPaths = @(
            "$winfspDir\bin\winfsp-x64.dll",
            "$winfspDir\bin\winfsp-x86.dll"
          )
          
          $foundDll = $null
          foreach ($dllPath in $dllPaths) {
            if (Test-Path $dllPath) {
              $foundDll = $dllPath
              break
            }
          }
          
          if ($foundDll) {
            Write-Host "`n✓ WinFsp DLL found at: $foundDll"
            $dll = Get-Item $foundDll
            Write-Host "  Size: $($dll.Length) bytes"
            Write-Host "  Modified: $($dll.LastWriteTime)"
          } else {
            Write-Error "✗ WinFsp DLL not found in: $winfspDir\bin\"
            Get-ChildItem "$winfspDir\bin\" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  Found: $_" }
            exit 1
          }
          
          # Verify bin directory is in PATH
          $binPath = "$winfspDir\bin"
          $pathEntries = $env:PATH -split ';'
          if ($pathEntries -contains $binPath) {
            Write-Host "✓ WinFsp bin directory is in PATH: $binPath"
          } else {
            Write-Host "⚠ WinFsp bin directory not in PATH array, checking substring..."
            if ($env:PATH -match [regex]::Escape($binPath)) {
              Write-Host "✓ WinFsp bin found in PATH (substring match)"
            } else {
              Write-Error "✗ WinFsp bin directory NOT in PATH: $binPath"
              exit 1
            }
          }
          
          Write-Host "`n=== Environment Summary ==="
          Write-Host "WINFSP_INSTALL_DIR: $env:WINFSP_INSTALL_DIR"
          Write-Host "CPATH: $env:CPATH"
          Write-Host "DLL: $foundDll"
        shell: pwsh

      - name: Build
        run: cargo build --verbose

      - name: Run unit tests
        run: cargo test --verbose
      
      - name: Run WinFsp integration tests
        # Run serially (--test-threads=1) because tests compete for drive letters
        run: cargo test --test winfsp_integration -- --ignored --nocapture --test-threads=1
      
      - name: Test Tauri app builds
        working-directory: src-tauri
        run: cargo build --verbose
      
      - name: Run Tauri unit tests
        working-directory: src-tauri
        run: cargo test --verbose
      
      - name: Check clippy
        run: cargo clippy -- -D warnings
        continue-on-error: true

  # Windows tests WITHOUT WinFsp - verifies fallback behavior
  # Note: These tests verify that the app builds and basic tests pass without WinFsp
  # The winfsp integration tests are skipped entirely since they require the DLL
  test-windows-no-winfsp:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-no-winfsp-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Verify WinFsp is NOT installed
        run: |
          if (Test-Path "C:\Program Files\WinFsp\bin\winfsp-x64.dll") {
            Write-Host "⚠ WinFsp is unexpectedly installed"
          } else {
            Write-Host "✓ WinFsp is NOT installed (expected for this test)"
          }
        shell: pwsh

      - name: Build (should succeed without WinFsp due to delay-loading)
        run: cargo build --verbose

      # Run only tests that don't touch WinFsp code paths
      # Skip all virtual_drive tests that might trigger WinFsp loading
      - name: Run safe unit tests (no WinFsp)
        run: |
          cargo test --verbose -- `
            --skip winfsp `
            --skip virtual_drive::tests::unlock `
            --skip virtual_drive::tests::lock `
            --skip virtual_drive::tests::vdrive_operations `
            --skip virtual_drive::tests::drive_content_persists `
            --skip virtual_drive::tests::is_winfsp `
            --skip virtual_drive::tests::uses_memory_mode `
            --skip virtual_drive::tests::uses_native_fs
        shell: pwsh
      
      # Skip the winfsp_integration tests entirely - they require the DLL
      - name: Note about skipped tests
        run: |
          Write-Host "ℹ WinFsp integration tests skipped (WinFsp not installed)"
          Write-Host "ℹ Run 'test-windows' job for full WinFsp testing"
        shell: pwsh

  test-linux:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

  test-macos:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

